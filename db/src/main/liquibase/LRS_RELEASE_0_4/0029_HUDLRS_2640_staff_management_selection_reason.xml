<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
    <changeSet context="All"  author="jordanchavez@kpmg.com" id="HUDLRS_2640_0001" objectQuotingStrategy="QUOTE_ALL_OBJECTS">
        <sql>
			<![CDATA[
CREATE TABLE CONSOLIDATED_SELECTION_REASON(
	CONSOLIDATED_SELECTION_REASON_ID UNIQUEIDENTIFIER NOT NULL DEFAULT NEWID(),
	CODE VARCHAR(50) NOT NULL,
	DESCRIPTION VARCHAR(50) NOT NULL
)
ALTER TABLE CONSOLIDATED_SELECTION_REASON ADD CONSTRAINT CONSOLIDATED_SELECTION_REASON_PK PRIMARY KEY(CONSOLIDATED_SELECTION_REASON_ID)
ALTER TABLE CONSOLIDATED_SELECTION_REASON ADD CONSTRAINT CONSOLIDATED_SELECTION_REASON_UQ_CODE UNIQUE(CODE)
GO
INSERT INTO CONSOLIDATED_SELECTION_REASON(CONSOLIDATED_SELECTION_REASON_ID, CODE, DESCRIPTION) VALUES(NEWID(), 'TEST_CASE', 'Test Case')
INSERT INTO CONSOLIDATED_SELECTION_REASON(CONSOLIDATED_SELECTION_REASON_ID, CODE, DESCRIPTION) VALUES(NEWID(), 'FHA_MANUAL', 'FHA Manual')
INSERT INTO CONSOLIDATED_SELECTION_REASON(CONSOLIDATED_SELECTION_REASON_ID, CODE, DESCRIPTION) VALUES(NEWID(), 'OIG_AUDIT', 'OIG Audit')
INSERT INTO CONSOLIDATED_SELECTION_REASON(CONSOLIDATED_SELECTION_REASON_ID, CODE, DESCRIPTION) VALUES(NEWID(), 'RISK_RANDOM', 'Risk/Random')
INSERT INTO CONSOLIDATED_SELECTION_REASON(CONSOLIDATED_SELECTION_REASON_ID, CODE, DESCRIPTION) VALUES(NEWID(), 'EARLY_CLAIM', 'Early Claim')
INSERT INTO CONSOLIDATED_SELECTION_REASON(CONSOLIDATED_SELECTION_REASON_ID, CODE, DESCRIPTION) VALUES(NEWID(), 'EARLY_PAYMENT_DEFAULT', 'Early Payment Default')
INSERT INTO CONSOLIDATED_SELECTION_REASON(CONSOLIDATED_SELECTION_REASON_ID, CODE, DESCRIPTION) VALUES(NEWID(), 'QC', 'QC')
INSERT INTO CONSOLIDATED_SELECTION_REASON(CONSOLIDATED_SELECTION_REASON_ID, CODE, DESCRIPTION) VALUES(NEWID(), 'LENDER_MONITORING', 'Lender Monitoring')
INSERT INTO CONSOLIDATED_SELECTION_REASON(CONSOLIDATED_SELECTION_REASON_ID, CODE, DESCRIPTION) VALUES(NEWID(), 'LENDER_SELF_REPORT', 'Lender Self Report')			
GO
ALTER TABLE SELECTION_REASON ADD CONSOLIDATED_SELECTION_REASON_ID UNIQUEIDENTIFIER NULL
ALTER TABLE SELECTION_REASON ADD CONSTRAINT SELECTION_REASON_FK_CONSOLIDATED_SELECTION_REASON_ID FOREIGN KEY(CONSOLIDATED_SELECTION_REASON_ID) REFERENCES CONSOLIDATED_SELECTION_REASON(CONSOLIDATED_SELECTION_REASON_ID)
GO
UPDATE SELECTION_REASON SET CONSOLIDATED_SELECTION_REASON_ID = (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'TEST_CASE') WHERE CODE = 'TEST_CASE'
UPDATE SELECTION_REASON SET CONSOLIDATED_SELECTION_REASON_ID = (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'FHA_MANUAL') WHERE CODE = 'FHA_MANUAL'
UPDATE SELECTION_REASON SET CONSOLIDATED_SELECTION_REASON_ID = (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'LENDER_SELF_REPORT') WHERE CODE = 'LENDER_SELF_REPORT'
UPDATE SELECTION_REASON SET CONSOLIDATED_SELECTION_REASON_ID = (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'OIG_AUDIT') WHERE CODE = 'OIG_AUDIT'
UPDATE SELECTION_REASON SET CONSOLIDATED_SELECTION_REASON_ID = (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'RISK_RANDOM') WHERE CODE = 'OTHER_NON_PERFORMING'
UPDATE SELECTION_REASON SET CONSOLIDATED_SELECTION_REASON_ID = (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'RISK_RANDOM') WHERE CODE = 'MONTHLY_RISK_THRESHOLD'
UPDATE SELECTION_REASON SET CONSOLIDATED_SELECTION_REASON_ID = (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'RISK_RANDOM') WHERE CODE = 'LENDER_INCREASED_SAMPLING'
UPDATE SELECTION_REASON SET CONSOLIDATED_SELECTION_REASON_ID = (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'RISK_RANDOM') WHERE CODE = 'UNDERWRITER_DECREASED_SAMPLING'
UPDATE SELECTION_REASON SET CONSOLIDATED_SELECTION_REASON_ID = (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'RISK_RANDOM') WHERE CODE = 'MONTHLY_RANDOM'
UPDATE SELECTION_REASON SET CONSOLIDATED_SELECTION_REASON_ID = (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'EARLY_CLAIM') WHERE CODE = 'EARLY_CLAIM'
UPDATE SELECTION_REASON SET CONSOLIDATED_SELECTION_REASON_ID = (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'EARLY_PAYMENT_DEFAULT') WHERE CODE = 'EARLY_PAYMENT_DEFAULT'
UPDATE SELECTION_REASON SET CONSOLIDATED_SELECTION_REASON_ID = (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'QC') WHERE CODE = 'NATIONAL_QC'
UPDATE SELECTION_REASON SET CONSOLIDATED_SELECTION_REASON_ID = (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'QC') WHERE CODE = 'REVIEW_LOCATION_QC'
UPDATE SELECTION_REASON SET CONSOLIDATED_SELECTION_REASON_ID = (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'LENDER_MONITORING') WHERE CODE = 'LENDER_MONITORING'
GO
ALTER TABLE SELECTION_REASON ALTER COLUMN CONSOLIDATED_SELECTION_REASON_ID UNIQUEIDENTIFIER NOT NULL
GO
INSERT INTO ASSIGNMENT_TYPE_ADMIN(ASSIGNMENT_TYPE_CD, ASSIGNMENT_TYPE_CATEGORY, CREATED_BY, UPDATED_BY, CREATED_TS, UPDATED_TS, ASSIGNMENT_TYPE_REF_ID) VALUES
	('M100', 'Staff Management Selection Reason', 'H00001', 'H00001', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'TEST_CASE')),
	('M110', 'Staff Management Selection Reason', 'H00001', 'H00001', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'FHA_MANUAL')),
	('M120', 'Staff Management Selection Reason', 'H00001', 'H00001', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'OIG_AUDIT')),
	('M130', 'Staff Management Selection Reason', 'H00001', 'H00001', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'RISK_RANDOM')),
	('M140', 'Staff Management Selection Reason', 'H00001', 'H00001', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'EARLY_CLAIM')),
	('M150', 'Staff Management Selection Reason', 'H00001', 'H00001', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'EARLY_PAYMENT_DEFAULT')),
	('M160', 'Staff Management Selection Reason', 'H00001', 'H00001', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'QC')),
	('M170', 'Staff Management Selection Reason', 'H00001', 'H00001', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'LENDER_MONITORING')),
	('M180', 'Staff Management Selection Reason', 'H00001', 'H00001', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, (SELECT CONSOLIDATED_SELECTION_REASON_ID FROM CONSOLIDATED_SELECTION_REASON WHERE CODE = 'LENDER_SELF_REPORT'))
GO
INSERT INTO PERSONNEL_ASSIGNMENT_TYPE(PERSONNEL_ASSIGNMENT_TYPE_ID, PERSONNEL_ID, ASSIGNMENT_TYPE_CD, ACTIVE_IND, CREATED_BY, UPDATED_BY, CREATED_TS, UPDATED_TS)
SELECT
	NEWID(),
	PAT.PERSONNEL_ID, 
	CSRAT.ASSIGNMENT_TYPE_CD,
	'Y',
	'H00001', 'H00001', 
	CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
FROM PERSONNEL_ASSIGNMENT_TYPE PAT
INNER JOIN ASSIGNMENT_TYPE_ADMIN SRAT ON (SRAT.ASSIGNMENT_TYPE_CD = PAT.ASSIGNMENT_TYPE_CD)
INNER JOIN SELECTION_REASON SR ON (SR.SELECTION_REASON_ID = SRAT.ASSIGNMENT_TYPE_REF_ID)
INNER JOIN CONSOLIDATED_SELECTION_REASON CSR ON (CSR.CONSOLIDATED_SELECTION_REASON_ID = SR.CONSOLIDATED_SELECTION_REASON_ID)
INNER JOIN ASSIGNMENT_TYPE_ADMIN CSRAT ON (CSRAT.ASSIGNMENT_TYPE_REF_ID = CSR.CONSOLIDATED_SELECTION_REASON_ID)
GROUP BY PAT.PERSONNEL_ID, CSRAT.ASSIGNMENT_TYPE_CD
ORDER BY PAT.PERSONNEL_ID, CSRAT.ASSIGNMENT_TYPE_CD
GO
DELETE FROM PERSONNEL_ASSIGNMENT_TYPE WHERE ASSIGNMENT_TYPE_CD LIKE 'S%'
GO
ALTER TABLE REVIEW_LEVEL_ITERATION_TIMEFRAME ADD CONSOLIDATED_SELECTION_REASON_ID UNIQUEIDENTIFIER NULL
ALTER TABLE REVIEW_LEVEL_ITERATION_TIMEFRAME ADD CONSTRAINT REVIEW_LEVEL_ITERATION_TIMEFRAME_FK_CONSOLIDATED_SELECTION_REASON_ID FOREIGN KEY(CONSOLIDATED_SELECTION_REASON_ID) REFERENCES CONSOLIDATED_SELECTION_REASON(CONSOLIDATED_SELECTION_REASON_ID)
GO
UPDATE TF SET TF.CONSOLIDATED_SELECTION_REASON_ID = SR.CONSOLIDATED_SELECTION_REASON_ID
FROM REVIEW_LEVEL_ITERATION_TIMEFRAME TF
INNER JOIN SELECTION_REASON SR ON (SR.SELECTION_REASON_ID = TF.SELECTION_REASON_ID)
INNER JOIN CONSOLIDATED_SELECTION_REASON CSR ON (CSR.CONSOLIDATED_SELECTION_REASON_ID = SR.CONSOLIDATED_SELECTION_REASON_ID)
GO
ALTER TABLE REVIEW_LEVEL_ITERATION_TIMEFRAME ALTER COLUMN CONSOLIDATED_SELECTION_REASON_ID UNIQUEIDENTIFIER NOT NULL
GO
DELETE TF1
FROM REVIEW_LEVEL_ITERATION_TIMEFRAME TF1
INNER JOIN REVIEW_LEVEL_ITERATION_TIMEFRAME TF2 ON (TF1.CONSOLIDATED_SELECTION_REASON_ID = TF2.CONSOLIDATED_SELECTION_REASON_ID) AND (TF1.REVIEW_LEVEL_TYPE_ID = TF2.REVIEW_LEVEL_TYPE_ID)
WHERE (TF1.REVIEW_LEVEL_ITERATION_TIMEFRAME_ID < TF2.REVIEW_LEVEL_ITERATION_TIMEFRAME_ID)
GO
ALTER TABLE REVIEW_LEVEL_ITERATION_TIMEFRAME DROP CONSTRAINT REVIEW_LEVEL_ITERATION_TIMEFRAME_UQ_SELECTION_REASON_ID_REVIEW_LEVEL_TYPE_ID
ALTER TABLE REVIEW_LEVEL_ITERATION_TIMEFRAME DROP CONSTRAINT REVIEW_LEVEL_ITERATION_TIMEFRAME_FK_SELECTION_REASON_ID
ALTER TABLE REVIEW_LEVEL_ITERATION_TIMEFRAME DROP COLUMN SELECTION_REASON_ID
GO
ALTER TABLE REVIEW_LEVEL_ITERATION_TIMEFRAME ADD CONSTRAINT REVIEW_LEVEL_ITERATION_TIMEFRAME_UQ_CONSOLIDATED_SELECTION_REASON_ID_REVIEW_LEVEL_TYPE_ID UNIQUE(CONSOLIDATED_SELECTION_REASON_ID, REVIEW_LEVEL_TYPE_ID)
GO
INSERT INTO DICT_METADATA_ENTITY(ENTITY_NAME, DB_VIEW_OR_TABLE, CREATED_BY,CREATED_TS) VALUES('Staff Management Selection Reason', 'CONSOLIDATED_SELECTION_REASON','C20225',getdate())
INSERT INTO DICT_METADATA_FIELD(ENTITY_NAME, FIELD_NAME, DB_COLUMN, CREATED_BY, CREATED_TS, DISPLAY_NAME)VALUES('Staff Management Selection Reason','Staff Management Selection Reason ID','CONSOLIDATED_SELECTION_REASON_ID','C20225',getdate(),'Staff Management Selection Reason ID')			
INSERT INTO DICT_METADATA_FIELD(ENTITY_NAME, FIELD_NAME, DB_COLUMN, CREATED_BY, CREATED_TS, DISPLAY_NAME)VALUES('Staff Management Selection Reason','Code','CODE','C20225',getdate(),'Code')			
INSERT INTO DICT_METADATA_FIELD(ENTITY_NAME, FIELD_NAME, DB_COLUMN, CREATED_BY, CREATED_TS, DISPLAY_NAME)VALUES('Staff Management Selection Reason','Description','DESCRIPTION','C20225',getdate(),'Description')						
INSERT INTO DICT_METADATA_FIELD(ENTITY_NAME, FIELD_NAME, DB_COLUMN, CREATED_BY, CREATED_TS, DISPLAY_NAME)VALUES('Selection Reason','Staff Management Selection Reason ID','CONSOLIDATED_SELECTION_REASON_ID','C20225',getdate(),'Staff Management Selection Reason ID')
INSERT INTO DICT_METADATA_FIELD(ENTITY_NAME, FIELD_NAME, DB_COLUMN, CREATED_BY, CREATED_TS, DISPLAY_NAME)VALUES('Review Level Iteration Timeframe','Staff Management Selection Reason ID','CONSOLIDATED_SELECTION_REASON_ID','C20225',getdate(),'Staff Management Selection Reason ID')
DELETE FROM DICT_METADATA_FIELD WHERE ENTITY_NAME = 'Review Level Iteration Timeframe' AND DB_COLUMN = 'SELECTION_REASON_ID'
			]]>
        </sql>
    </changeSet>
</databaseChangeLog>
