<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
	<changeSet context="All"  author="jordanchavez@kpmg.com" id="HUDLRS_3771_0001" objectQuotingStrategy="QUOTE_ALL_OBJECTS">
		<sql>
			<![CDATA[
ALTER TABLE BATCH ADD OPERATIONAL_DOCUMENTS_DUE_DT DATETIME NULL;

ALTER TABLE BATCH ADD SELECTION_REASON_ID UNIQUEIDENTIFIER NULL;
ALTER TABLE BATCH ADD CONSTRAINT BATCH_FK_SELECTION_REASON_ID FOREIGN KEY(SELECTION_REASON_ID) REFERENCES SELECTION_REASON(SELECTION_REASON_ID);

UPDATE B SET SELECTION_REASON_ID = RQ.SELECTION_REASON_ID
FROM BATCH B
INNER JOIN MANUAL_SELECTION_REQUEST RQ ON (RQ.SELECTION_REQUEST_ID = B.SELECTION_REQUEST_ID);

UPDATE B SET SELECTION_REASON_ID = (SELECT SELECTION_REASON_ID FROM SELECTION_REASON WHERE CODE = 'LENDER_MONITORING')
FROM BATCH B
INNER JOIN LENDER_MONITORING_SELECTION_REQUEST RQ ON (RQ.SELECTION_REQUEST_ID = B.SELECTION_REQUEST_ID);

UPDATE B SET SELECTION_REASON_ID = (SELECT SELECTION_REASON_ID FROM SELECTION_REASON WHERE CODE = 'LENDER_SELF_REPORT')
FROM BATCH B
INNER JOIN LENDER_SELF_REPORT_SELECTION_REQUEST RQ ON (RQ.SELECTION_REQUEST_ID = B.SELECTION_REQUEST_ID);

ALTER TABLE BATCH ALTER COLUMN SELECTION_REASON_ID UNIQUEIDENTIFIER NOT NULL;

ALTER TABLE AUDIT_BATCH ADD OPERATIONAL_DOCUMENTS_DUE_DT DATETIME NULL;
ALTER TABLE AUDIT_BATCH ADD SELECTION_REASON_ID UNIQUEIDENTIFIER NULL;
ALTER TABLE AUDIT_BATCH ADD REVIEW_TYPE_ID UNIQUEIDENTIFIER NULL;
ALTER TABLE AUDIT_BATCH ADD REVIEW_LEVEL_TYPE_ID UNIQUEIDENTIFIER NULL;
ALTER TABLE AUDIT_BATCH ADD ITERATION_NUMBER SMALLINT NULL;
			]]>
		</sql>
	</changeSet>
	<changeSet context="All"  author="jordanchavez@kpmg.com" id="HUDLRS_3771_0002" objectQuotingStrategy="QUOTE_ALL_OBJECTS">
		<sql>
			<![CDATA[
ALTER TRIGGER [DBO].[TU_BATCH] ON [DBO].[BATCH] FOR UPDATE AS BEGIN
	INSERT INTO AUDIT_BATCH(
		BATCH_ID ,
		OWNER_PERSONNEL_ID ,
		MTGEE5,
		ORIGINAL_OWNER_PERSONNEL_ID ,
		CREATED_BY ,
		UPDATED_BY ,
		CREATED_TS ,
		UPDATED_TS ,
		BATCH_REFERENCE_ID,
		OPERATIONAL_REVIEW_IND,
		REQUEST_OPERATIONAL_DOCUMENTS_IND,
		OPERATIONAL_DOCUMENTS_DUE_DT,
		SECONDARY_REFERENCE,
		OPERATIONAL_REVIEW_GUIDANCE,
		SELECTION_REQUEST_ID,
		BATCH_STATUS_ID,
		REVIEW_LOCATION_ID,
		RECEIVED_OPERATIONAL_DOCUMENTS_IND,
		SELECTION_REASON_ID,
		REVIEW_TYPE_ID,
		REVIEW_LEVEL_TYPE_ID,
		ITERATION_NUMBER,
		AUDIT_CREATED_TS,
		AUDIT_ACTION_CODE
	)
	SELECT
		BATCH_ID ,
		OWNER_PERSONNEL_ID ,
		MTGEE5,
		ORIGINAL_OWNER_PERSONNEL_ID ,
		CREATED_BY ,
		UPDATED_BY ,
		CREATED_TS ,
		UPDATED_TS ,
		BATCH_REFERENCE_ID,
		OPERATIONAL_REVIEW_IND,
		REQUEST_OPERATIONAL_DOCUMENTS_IND,
		OPERATIONAL_DOCUMENTS_DUE_DT,
		SECONDARY_REFERENCE,
		OPERATIONAL_REVIEW_GUIDANCE,
		SELECTION_REQUEST_ID,
		BATCH_STATUS_ID,
		REVIEW_LOCATION_ID,
		RECEIVED_OPERATIONAL_DOCUMENTS_IND,
		SELECTION_REASON_ID,
		REVIEW_TYPE_ID,
		REVIEW_LEVEL_TYPE_ID,
		ITERATION_NUMBER,
		GETDATE(),
		'U'
	FROM INSERTED
END
			]]>
		</sql>
	</changeSet>
</databaseChangeLog>
