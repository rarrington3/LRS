<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
    <changeSet context="All"  author="jordanchavez" id="HUDLRS_3231_0001" objectQuotingStrategy="QUOTE_ALL_OBJECTS">
        <sql>
            <![CDATA[
IF (COL_LENGTH('DBO.LENDER_SELF_REPORT_SELECTION_REQUEST', 'REVIEW_TYPE_ID') IS NULL)
	ALTER TABLE LENDER_SELF_REPORT_SELECTION_REQUEST ADD REVIEW_TYPE_ID UNIQUEIDENTIFIER NULL;

IF (NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS WHERE CONSTRAINT_NAME = 'LENDER_SELF_REPORT_SELECTION_REQUEST_FK_REVIEW_TYPE_ID'))
    ALTER TABLE LENDER_SELF_REPORT_SELECTION_REQUEST ADD CONSTRAINT LENDER_SELF_REPORT_SELECTION_REQUEST_FK_REVIEW_TYPE_ID FOREIGN KEY(REVIEW_TYPE_ID) REFERENCES REVIEW_TYPE_REF(REVIEW_TYPE_ID);

UPDATE LENDER_SELF_REPORT_SELECTION_REQUEST SET REVIEW_TYPE_ID = (SELECT REVIEW_TYPE_ID FROM REVIEW_TYPE_REF WHERE REVIEW_TYPE_CD = 'U') WHERE REVIEW_TYPE_ID IS NULL;

ALTER TABLE LENDER_SELF_REPORT_SELECTION_REQUEST ALTER COLUMN REVIEW_TYPE_ID UNIQUEIDENTIFIER NOT NULL;

IF (EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'LENDER_SELF_REPORT_SELECTION_REQUEST_DEFECT_TYPE_REF'))
    DROP TABLE LENDER_SELF_REPORT_SELECTION_REQUEST_DEFECT_TYPE_REF;

IF (EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'DEFECT_TYPE_REF'))
    DROP TABLE DEFECT_TYPE_REF;

IF (EXISTS (SELECT * FROM INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS WHERE CONSTRAINT_NAME = 'LENDER_SELF_REPORT_SELECTION_REQUEST_FK_LENDER_ID'))
    ALTER TABLE LENDER_SELF_REPORT_SELECTION_REQUEST DROP CONSTRAINT LENDER_SELF_REPORT_SELECTION_REQUEST_FK_LENDER_ID;

IF (EXISTS (SELECT * FROM INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS WHERE CONSTRAINT_NAME = 'LENDER_SELF_REPORT_SELECTION_REQUEST'))
    ALTER TABLE LENDER_SELF_REPORT_SELECTION_REQUEST DROP COLUMN LENDER_ID;
            ]]>
        </sql>
    </changeSet>	
</databaseChangeLog>