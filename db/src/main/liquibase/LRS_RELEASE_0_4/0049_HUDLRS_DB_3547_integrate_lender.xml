<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
    <changeSet context="All"  author="jordanchavez" id="HUDLRS_3547_0001" objectQuotingStrategy="QUOTE_ALL_OBJECTS">
		<validCheckSum>7:92e64953febc604d5bd9850317d5ae4f</validCheckSum>
        <sql>
            <![CDATA[
ALTER TABLE LENDER DROP CONSTRAINT LENDER_PK
GO
ALTER TABLE LENDER ALTER COLUMN LENDER_ID CHAR(5) NOT NULL
GO
ALTER TABLE LENDER ADD CONSTRAINT LENDER_PK PRIMARY KEY NONCLUSTERED(LENDER_ID)
GO

INSERT INTO LENDER(LENDER_ID, NAME, EMAIL, SECONDARY_EMAIL, CREATED_BY, CREATED_DT)
SELECT DISTINCT
	X.MTGEE5,
	'<Lender ' + X.MTGEE5 + ' not found>',
	null,
	null,
	'LRSSYS',
	CURRENT_TIMESTAMP
FROM BATCH X
LEFT JOIN LENDER L ON (L.LENDER_ID = X.MTGEE5)
WHERE (L.LENDER_ID IS NULL)
GO
ALTER TABLE BATCH ADD CONSTRAINT BATCH_FK_MTGEE5 FOREIGN KEY(MTGEE5) REFERENCES LENDER(LENDER_ID)
GO

INSERT INTO LENDER(LENDER_ID, NAME, EMAIL, SECONDARY_EMAIL, CREATED_BY, CREATED_DT)
SELECT DISTINCT
	X.MTGEE5,
	'<Lender ' + X.MTGEE5 + ' not found>',
	null,
	null,
	'LRSSYS',
	CURRENT_TIMESTAMP
FROM LENDER_INCREASED_SELECTION X
LEFT JOIN LENDER L ON (L.LENDER_ID = X.MTGEE5)
WHERE (L.LENDER_ID IS NULL)
GO
ALTER TABLE LENDER_INCREASED_SELECTION ADD CONSTRAINT LENDER_INCREASED_SELECTION_FK_MTGEE5 FOREIGN KEY(MTGEE5) REFERENCES LENDER(LENDER_ID)
GO

INSERT INTO LENDER(LENDER_ID, NAME, EMAIL, SECONDARY_EMAIL, CREATED_BY, CREATED_DT)
SELECT DISTINCT
	X.MTGEE5,
	'<Lender ' + X.MTGEE5 + ' not found>',
	null,
	null,
	'LRSSYS',
	CURRENT_TIMESTAMP
FROM LENDER_SUPPRESSION X
LEFT JOIN LENDER L ON (L.LENDER_ID = X.MTGEE5)
WHERE (L.LENDER_ID IS NULL)
GO
ALTER TABLE LENDER_SUPPRESSION ADD CONSTRAINT LENDER_SUPPRESSION_FK_MTGEE5 FOREIGN KEY(MTGEE5) REFERENCES LENDER(LENDER_ID)
GO

INSERT INTO LENDER(LENDER_ID, NAME, EMAIL, SECONDARY_EMAIL, CREATED_BY, CREATED_DT)
SELECT DISTINCT
	X.MTGEE5,
	'<Lender ' + X.MTGEE5 + ' not found>',
	null,
	null,
	'LRSSYS',
	CURRENT_TIMESTAMP
FROM LOAN_SELECTION X
LEFT JOIN LENDER L ON (L.LENDER_ID = X.MTGEE5)
WHERE (L.LENDER_ID IS NULL)
GO
ALTER TABLE LOAN_SELECTION ADD CONSTRAINT LOAN_SELECTION_FK_MTGEE5 FOREIGN KEY(MTGEE5) REFERENCES LENDER(LENDER_ID)
GO

INSERT INTO LENDER(LENDER_ID, NAME, EMAIL, SECONDARY_EMAIL, CREATED_BY, CREATED_DT)
SELECT DISTINCT
	X.MTGEE5,
	'<Lender ' + X.MTGEE5 + ' not found>',
	null,
	null,
	'LRSSYS',
	CURRENT_TIMESTAMP
FROM LOAN_SELECTION_PENDING X
LEFT JOIN LENDER L ON (L.LENDER_ID = X.MTGEE5)
WHERE (L.LENDER_ID IS NULL)
GO
ALTER TABLE LOAN_SELECTION_PENDING ADD CONSTRAINT LOAN_SELECTION_PENDING_FK_MTGEE5 FOREIGN KEY(MTGEE5) REFERENCES LENDER(LENDER_ID)
GO

ALTER TABLE REVIEW ALTER COLUMN MTGEE5 CHAR(5) NULL
GO
INSERT INTO LENDER(LENDER_ID, NAME, EMAIL, SECONDARY_EMAIL, CREATED_BY, CREATED_DT)
SELECT DISTINCT
	X.MTGEE5,
	'<Lender ' + X.MTGEE5 + ' not found>',
	null,
	null,
	'LRSSYS',
	CURRENT_TIMESTAMP
FROM REVIEW X
LEFT JOIN LENDER L ON (L.LENDER_ID = X.MTGEE5)
WHERE (L.LENDER_ID IS NULL) AND (X.MTGEE5 IS NOT NULL)
GO
ALTER TABLE REVIEW ADD CONSTRAINT REVIEW_FK_MTGEE5 FOREIGN KEY(MTGEE5) REFERENCES LENDER(LENDER_ID)
GO

ALTER TABLE LENDER_MONITORING_SELECTION_REQUEST ALTER COLUMN LENDER_ID CHAR(5) NULL
GO
INSERT INTO LENDER(LENDER_ID, NAME, EMAIL, SECONDARY_EMAIL, CREATED_BY, CREATED_DT)
SELECT DISTINCT
	X.LENDER_ID,
	'<Lender ' + X.LENDER_ID + ' not found>',
	null,
	null,
	'LRSSYS',
	CURRENT_TIMESTAMP
FROM LENDER_MONITORING_SELECTION_REQUEST X
LEFT JOIN LENDER L ON (L.LENDER_ID = X.LENDER_ID)
WHERE (L.LENDER_ID IS NULL)
GO
ALTER TABLE LENDER_MONITORING_SELECTION_REQUEST ADD CONSTRAINT LENDER_MONITORING_SELECTION_REQUEST_FK_LENDER_ID FOREIGN KEY(LENDER_ID) REFERENCES LENDER(LENDER_ID)
GO

ALTER TABLE LENDER_SELF_REPORT_SELECTION_REQUEST ALTER COLUMN LENDER_ID CHAR(5) NULL
GO
INSERT INTO LENDER(LENDER_ID, NAME, EMAIL, SECONDARY_EMAIL, CREATED_BY, CREATED_DT)
SELECT DISTINCT
	X.LENDER_ID,
	'<Lender ' + X.LENDER_ID + ' not found>',
	null,
	null,
	'LRSSYS',
	CURRENT_TIMESTAMP
FROM LENDER_SELF_REPORT_SELECTION_REQUEST X
LEFT JOIN LENDER L ON (L.LENDER_ID = X.LENDER_ID)
WHERE (L.LENDER_ID IS NULL)
GO
ALTER TABLE LENDER_SELF_REPORT_SELECTION_REQUEST ADD CONSTRAINT LENDER_SELF_REPORT_SELECTION_REQUEST_FK_LENDER_ID FOREIGN KEY(LENDER_ID) REFERENCES LENDER(LENDER_ID)
GO
            ]]>
        </sql>
    </changeSet>
</databaseChangeLog>
