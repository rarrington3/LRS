<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
    <changeSet context="All"  author="jordanchavez" id="HUDLRS_3506_0001" objectQuotingStrategy="QUOTE_ALL_OBJECTS">
        <sql>
            <![CDATA[
CREATE TABLE JOB_STATUS_REF(
    JOB_STATUS_ID UNIQUEIDENTIFIER NOT NULL,
    CODE VARCHAR(50) NOT NULL,
    DESCRIPTION VARCHAR(50) NOT NULL
);
ALTER TABLE JOB_STATUS_REF ADD CONSTRAINT JOB_STATUS_REF_PK PRIMARY KEY NONCLUSTERED(JOB_STATUS_ID);
ALTER TABLE JOB_STATUS_REF ADD CONSTRAINT JOB_STATUS_REF_UQ_CODE UNIQUE(CODE);
ALTER TABLE JOB_STATUS_REF ADD CONSTRAINT JOB_STATUS_REF_DF_JOB_STATUS_ID DEFAULT NEWID() FOR JOB_STATUS_ID;

INSERT INTO JOB_STATUS_REF(CODE, DESCRIPTION) VALUES
    ('PENDING', 'Pending'),
    ('COMPLETED', 'Completed'),
    ('CANCELLED', 'Cancelled');

ALTER TABLE JOB ADD JOB_STATUS_ID UNIQUEIDENTIFIER NULL;
ALTER TABLE JOB ADD CONSTRAINT JOB_FK_JOB_STATUS_ID FOREIGN KEY(JOB_STATUS_ID) REFERENCES JOB_STATUS_REF(JOB_STATUS_ID);

UPDATE JOB SET JOB_STATUS_ID = (SELECT JOB_STATUS_ID FROM JOB_STATUS_REF WHERE CODE = 'CANCELLED') WHERE (CANCELLED = 1);

UPDATE J SET J.JOB_STATUS_ID = (SELECT JOB_STATUS_ID FROM JOB_STATUS_REF WHERE CODE = 'COMPLETED')
FROM JOB J 
INNER JOIN JOB_EXECUTION JE ON (JE.JOB_ID = J.JOB_ID)
INNER JOIN JOB_EXECUTION_STATUS_REF JES ON (JES.JOB_EXECUTION_STATUS_ID = JE.JOB_EXECUTION_STATUS_ID)
WHERE (JES.CODE = 'COMPLETED');

UPDATE JOB SET JOB_STATUS_ID = (SELECT JOB_STATUS_ID FROM JOB_STATUS_REF WHERE CODE = 'PENDING') WHERE (JOB_STATUS_ID IS NULL);

ALTER TABLE JOB ALTER COLUMN JOB_STATUS_ID UNIQUEIDENTIFIER NOT NULL;

ALTER TABLE JOB DROP COLUMN CANCELLED;

EXEC SP_RENAME 'JOB.CREATED_DT', 'CREATED_TS';
EXEC SP_RENAME 'JOB.UPDATED_DT', 'UPDATED_TS';

EXEC SP_RENAME 'JOB_EXECUTION.CREATED_DT', 'CREATED_TS';
EXEC SP_RENAME 'JOB_EXECUTION.UPDATED_DT', 'UPDATED_TS';

ALTER TABLE JOB_TYPE_REF DROP COLUMN CREATED_BY;
ALTER TABLE JOB_TYPE_REF DROP COLUMN CREATED_TS;
ALTER TABLE JOB_TYPE_REF DROP COLUMN UPDATED_BY;
ALTER TABLE JOB_TYPE_REF DROP COLUMN UPDATED_TS;

ALTER TABLE JOB_EXECUTION_STATUS_REF DROP COLUMN CREATED_BY;
ALTER TABLE JOB_EXECUTION_STATUS_REF DROP COLUMN CREATED_DT;
ALTER TABLE JOB_EXECUTION_STATUS_REF DROP COLUMN UPDATED_BY;
ALTER TABLE JOB_EXECUTION_STATUS_REF DROP COLUMN UPDATED_DT;

EXEC SP_RENAME 'LENDER.CREATED_DT', 'CREATED_TS';
EXEC SP_RENAME 'LENDER.UPDATED_DT', 'UPDATED_TS';
            ]]>
        </sql>
    </changeSet>	

    <changeSet context="All"  author="jordanchavez" id="HUDLRS_3506_0002" objectQuotingStrategy="QUOTE_ALL_OBJECTS">
        <sql>
            <![CDATA[
ALTER TABLE JOB ALTER COLUMN UPDATED_BY CHAR(6) NULL
ALTER TABLE JOB ALTER COLUMN UPDATED_TS DATETIME NULL

ALTER TABLE JOB_EXECUTION ALTER COLUMN UPDATED_BY CHAR(6) NULL
ALTER TABLE JOB_EXECUTION ALTER COLUMN UPDATED_TS DATETIME NULL
            ]]>
        </sql>
    </changeSet>	
</databaseChangeLog>