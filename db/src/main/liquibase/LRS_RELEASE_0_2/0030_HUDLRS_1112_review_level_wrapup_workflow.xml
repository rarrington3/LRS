<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
    <changeSet context="ALL"  author="jordanchavez@kpmg.com" id="0030_HUDLRS_1112_revieww_level_wrapup_workflow_1" objectQuotingStrategy="QUOTE_ALL_OBJECTS">
        <sql>
            <![CDATA[
                UPDATE REVIEW_LEVEL SET ITERATION_NUM = 0 WHERE ITERATION_NUM IS NULL
                DROP INDEX RVW_LVL_RVW_TYPE_ITERATION_IDX ON REVIEW_LEVEL
                ALTER TABLE REVIEW_LEVEL ALTER COLUMN ITERATION_NUM NUMERIC(3, 0) NOT NULL
                CREATE NONCLUSTERED INDEX RVW_LVL_RVW_TYPE_ITERATION_IDX ON REVIEW_LEVEL
                (
                    REVIEW_LVL_ID,
                    REVIEW_LEVEL_ID,
                    ITERATION_NUM
                )

                ALTER TABLE RQST_FROM_LENDER ADD CONSTRAINT RQST_FROM_LENDER_FK_REVIEW FOREIGN KEY(REVIEW_ID) REFERENCES REVIEW(REVIEW_ID)
                ALTER TABLE REVIEW ADD CONSTRAINT REVIEW_FK_ORIG_RVWR_PRSNNL_ID FOREIGN KEY(ORIG_RVWR_PRSNNL_ID) REFERENCES PERSONNEL(PRSNNL_ID)
                ALTER TABLE REVIEW_LEVEL ADD CONSTRAINT REVIEW_LEVEL_FK_ORIG_RVWR_PRSNNL_ID FOREIGN KEY(ORIG_RVWR_PRSNNL_ID) REFERENCES PERSONNEL(PRSNNL_ID)
                ALTER TABLE REVIEW_LEVEL ADD CONSTRAINT REVIEW_LEVEL_FK_RVWR_PRSNNL_ID FOREIGN KEY(RVWR_PRSNNL_ID) REFERENCES PERSONNEL(PRSNNL_ID)
                ALTER TABLE REVIEW_LOCATION ADD CONSTRAINT REVIEW_LOCATION_FK_OWNER_PRSNNL_ID FOREIGN KEY(OWNER_PRSNNL_ID) REFERENCES PERSONNEL(PRSNNL_ID)
                ALTER TABLE REVIEW_LEVEL ADD CONSTRAINT REVIEW_LEVEL_FK_RVW_LOCATION_ID FOREIGN KEY(RVW_LOCATION_ID) REFERENCES REVIEW_LOCATION(RVW_LOCATION_ID)
                ALTER TABLE LOAN_SELECTION ADD CONSTRAINT LOAN_SELECTION_FK_RVW_LOCATION_ID FOREIGN KEY(RVW_LOCATION_ID) REFERENCES REVIEW_LOCATION(RVW_LOCATION_ID)
                ALTER TABLE EXCEPTION ADD CONSTRAINT EXCEPTION_FK_REVIEW_ID FOREIGN KEY(REVIEW_ID) REFERENCES REVIEW(REVIEW_ID)
                ALTER TABLE PERSONNEL ADD CONSTRAINT PERSONNEL_FK_REVIEW_LOCATION FOREIGN KEY(RVW_LOCATION_ID) REFERENCES REVIEW_LOCATION(RVW_LOCATION_ID)
                ALTER TABLE PERSONNEL ADD CONSTRAINT PERSONNEL_FK_REPORTS_TO_PRSNNL_ID FOREIGN KEY(REPORTS_TO_PRSNNL_ID) REFERENCES PERSONNEL(PRSNNL_ID)
                ALTER TABLE PERSONNEL ADD CONSTRAINT PERSONNEL_FK_VETTING_PRSNNL_ID FOREIGN KEY(VETTING_PRSNNL_ID) REFERENCES PERSONNEL(PRSNNL_ID)

                ALTER TABLE REVIEW ADD JBPM_PROCESS_ID BIGINT NULL
                INSERT INTO DICT_METADATA_FIELD(ENTITY_NAME, FIELD_NAME, DB_COLUMN, CREATED_BY, CREATED_TS, UI_CONTROL_TYPE, DISPLAY_NAME)
                VALUES('REVIEW', 'JBPM PROCESS ID', 'JBPM_PROCESS_ID', 'jchavz', GETDATE(), 'STATIC', 'JBPM PROCESS ID')

                ALTER TABLE REVIEW_LEVEL_REF ALTER COLUMN REVIEW_LEVEL_CD VARCHAR(4) NOT NULL
            ]]>
        </sql>
    </changeSet>
    <changeSet context="Test"  author="jordanchavez@kpmg.com" id="0030_HUDLRS_1112_revieww_level_wrapup_workflow_2" objectQuotingStrategy="QUOTE_ALL_OBJECTS">
        <sql>
            <![CDATA[
                UPDATE LOAN_SELECTION SET SLCTN_REASON_ID = (SELECT SLCTN_REASON_ID FROM SELECTION_PARAMETERS WHERE SELECTION_REASON_NAME = 'Test Case')
            ]]>
        </sql>
    </changeSet>
</databaseChangeLog>
