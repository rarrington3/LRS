<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
    <changeSet context="All"  author="jordanchavez@kpmg.com" id="HUDLRS_1858_0001" objectQuotingStrategy="QUOTE_ALL_OBJECTS">
        <sql>
		<![CDATA[
CREATE TABLE JOB_TYPE_REF(
	JOB_TYPE_ID UNIQUEIDENTIFIER NOT NULL,
	CODE VARCHAR(50) NOT NULL,
	DESCRIPTION VARCHAR(50) NOT NULL,
	CREATED_BY CHAR(6) NOT NULL,
	CREATED_DT DATETIME NOT NULL,
	UPDATED_BY CHAR(6) NOT NULL,
	UPDATED_DT DATETIME NOT NULL,
	CONSTRAINT JOB_TYPE_REF_PK PRIMARY KEY NONCLUSTERED(JOB_TYPE_ID),
	CONSTRAINT JOB_TYPE_REF_UQ_CODE UNIQUE(CODE),
)
GO
INSERT INTO JOB_TYPE_REF(JOB_TYPE_ID, CODE, DESCRIPTION, CREATED_BY, CREATED_DT, UPDATED_BY, UPDATED_DT) VALUES
	(NEWID(), 'EARLY_CLAIM_SELECTION', 'Early Claim Selection', 'jchav', CURRENT_TIMESTAMP, 'jchav', CURRENT_TIMESTAMP),
	(NEWID(), 'EARLY_PENDING_DEFAULT_SELECTION', 'Early Pending Default Selection', 'jchav', CURRENT_TIMESTAMP, 'jchav', CURRENT_TIMESTAMP),
	(NEWID(), 'ENDORSEMENT_SELECTION', 'Endorsement Selection', 'jchav', CURRENT_TIMESTAMP, 'jchav', CURRENT_TIMESTAMP),
	(NEWID(), 'NATIONAL_QC_SELECTION', 'National QC Selection', 'jchav', CURRENT_TIMESTAMP, 'jchav', CURRENT_TIMESTAMP),
	(NEWID(), 'AGGREGATION', 'Aggregation', 'jchav', CURRENT_TIMESTAMP, 'jchav', CURRENT_TIMESTAMP),
	(NEWID(), 'DISTRIBUTION', 'Distribution', 'jchav', CURRENT_TIMESTAMP, 'jchav', CURRENT_TIMESTAMP),
	(NEWID(), 'BINDER_DELIVERY_CHECK', 'Binder Delivery Check', 'jchav', CURRENT_TIMESTAMP, 'jchav', CURRENT_TIMESTAMP)
GO

CREATE TABLE JOB(
	JOB_ID UNIQUEIDENTIFIER NOT NULL,
	JOB_TYPE_ID UNIQUEIDENTIFIER NOT NULL,
	CANCELLED BIT NOT NULL,
	OFFICIAL_DT DATETIME NULL,
	START_DT DATETIME NULL,
	END_DT DATETIME NULL,
	CREATED_BY CHAR(6) NOT NULL,
	CREATED_DT DATETIME NOT NULL,
	UPDATED_BY CHAR(6) NOT NULL,
	UPDATED_DT DATETIME NOT NULL,
	CONSTRAINT JOB_PK PRIMARY KEY NONCLUSTERED(JOB_ID),
	CONSTRAINT JOB_FK_JOB_TYPE_ID FOREIGN KEY(JOB_TYPE_ID) REFERENCES JOB_TYPE_REF(JOB_TYPE_ID),
)
GO

CREATE TABLE JOB_EXECUTION_STATUS_REF(
	JOB_EXECUTION_STATUS_ID UNIQUEIDENTIFIER NOT NULL,
	CODE VARCHAR(50) NOT NULL,
	DESCRIPTION VARCHAR(50) NOT NULL,
	CREATED_BY CHAR(6) NOT NULL,
	CREATED_DT DATETIME NOT NULL,
	UPDATED_BY CHAR(6) NOT NULL,
	UPDATED_DT DATETIME NOT NULL,
	CONSTRAINT JOB_EXECUTION_STATUS_REF_PK PRIMARY KEY NONCLUSTERED(JOB_EXECUTION_STATUS_ID),
	CONSTRAINT JOB_EXECUTION_STATUS_REF_UQ_CODE UNIQUE(CODE),
)
GO
INSERT INTO JOB_EXECUTION_STATUS_REF(JOB_EXECUTION_STATUS_ID, CODE, DESCRIPTION, CREATED_BY, CREATED_DT, UPDATED_BY, UPDATED_DT) VALUES
	(NEWID(), 'STARTED', 'Started', 'jchav', CURRENT_TIMESTAMP, 'jchav', CURRENT_TIMESTAMP),
	(NEWID(), 'COMPLETED', 'Completed', 'jchav', CURRENT_TIMESTAMP, 'jchav', CURRENT_TIMESTAMP),
	(NEWID(), 'FAILED', 'Failed', 'jchav', CURRENT_TIMESTAMP, 'jchav', CURRENT_TIMESTAMP)
GO

CREATE TABLE JOB_EXECUTION(
	JOB_EXECUTION_ID UNIQUEIDENTIFIER NOT NULL,
	JOB_ID UNIQUEIDENTIFIER NOT NULL,
	JOB_EXECUTION_STATUS_ID UNIQUEIDENTIFIER NOT NULL,
	EXCEPTION_DETAILS VARCHAR(MAX) NULL,
	ENDED_DT DATETIME NULL,
	CREATED_BY CHAR(6) NOT NULL,
	CREATED_DT DATETIME NOT NULL,
	UPDATED_BY CHAR(6) NOT NULL,
	UPDATED_DT DATETIME NOT NULL,
	CONSTRAINT JOB_EXECUTION_PK PRIMARY KEY NONCLUSTERED(JOB_EXECUTION_ID),
	CONSTRAINT JOB_EXECUTION_FK_JOB_ID FOREIGN KEY(JOB_ID) REFERENCES JOB(JOB_ID),
	CONSTRAINT JOB_EXECUTION_FK_JOB_EXECUTION_STATUS_ID FOREIGN KEY(JOB_EXECUTION_STATUS_ID) REFERENCES JOB_EXECUTION_STATUS_REF(JOB_EXECUTION_STATUS_ID),
)
GO

ALTER TABLE UNIVERSE_SELECTION_REQUEST DROP COLUMN JBPM_PROCESS_ID
ALTER TABLE UNIVERSE_SELECTION_REQUEST DROP COLUMN AUTOMATIC_IND
ALTER TABLE UNIVERSE_SELECTION_REQUEST ADD JOB_ID UNIQUEIDENTIFIER NOT NULL
ALTER TABLE UNIVERSE_SELECTION_REQUEST ADD CONSTRAINT UNIVERSE_SELECTION_REQUEST_FK_JOB_ID FOREIGN KEY(JOB_ID) REFERENCES JOB(JOB_ID)
GO

ALTER TABLE SCORING_MODEL_FACTOR ALTER COLUMN WEIGHT numeric(10, 5) NOT NULL
GO

ALTER TABLE SCORING_FACTOR ALTER COLUMN FACTOR_ATTRIBUTE_NAME varchar(100) NOT NULL
GO

ALTER TABLE MODEL_SCORE DROP CONSTRAINT MODEL_SCORE_PK
ALTER TABLE MODEL_SCORE ADD CONSTRAINT MODEL_SCORE_PK PRIMARY KEY NONCLUSTERED(MODEL_SCORE_ID)

ALTER TABLE MODEL_SCORE DROP CONSTRAINT MODEL_SCORE_UQ_SELECTION_ID_MODEL_ID
ALTER TABLE MODEL_SCORE ADD CONSTRAINT MODEL_SCORE_UQ_SELECTION_ID_MODEL_ID_MODEL_VER_NUM UNIQUE(SELECTION_ID, MODEL_ID, MODEL_VER_NUM)

GO
		]]>
        </sql>
    </changeSet>	
</databaseChangeLog>
