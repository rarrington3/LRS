<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
    <changeSet context="All"  author="jordanchavez@kpmg.com" id="HUDLRS_12472341_0001" objectQuotingStrategy="QUOTE_ALL_OBJECTS">
        <sql>
			<![CDATA[
EXEC SP_RENAME 'REQUESTED_BINDER_STATUS_REF', 'BINDER_REQUEST_STATUS_REF'
GO
EXEC SP_RENAME 'BINDER_REQUEST_STATUS_REF.REQUESTED_BINDER_STATUS_ID', 'BINDER_REQUEST_STATUS_ID'
EXEC SP_RENAME 'REQUESTED_BINDER_STATUS_REF_PK', 'BINDER_REQUEST_STATUS_REF_PK'
GO
EXEC SP_RENAME 'REQUESTED_BINDER', 'BINDER_REQUEST'
GO
EXEC SP_RENAME 'BINDER_REQUEST.REQUESTED_BINDER_ID', 'BINDER_REQUEST_ID'
EXEC SP_RENAME 'BINDER_REQUEST.REQUESTED_BINDER_STATUS_ID', 'BINDER_REQUEST_STATUS_ID'
EXEC SP_RENAME 'REQUESTED_BINDER_PK', 'BINDER_REQUEST_PK'
EXEC SP_RENAME 'REQUESTED_BINDER_FK_REQUESTED_BINDER_STATUS_ID', 'BINDER_REQUEST_FK_BINDER_REQUEST_STATUS_ID'
EXEC SP_RENAME 'REQUESTED_BINDER_FK_SELECTION_ID', 'BINDER_REQUEST_FK_SELECTION_ID'
GO

ALTER TABLE BINDER_REQUEST DROP COLUMN BINDER_ID
ALTER TABLE BINDER_REQUEST DROP COLUMN WAS_DOWNLOADED_IND
ALTER TABLE BINDER_REQUEST DROP COLUMN REQUESTED_FROM

ALTER TABLE BINDER_REQUEST ALTER COLUMN REQUESTED_DATE DATETIME NOT NULL
ALTER TABLE BINDER_REQUEST ALTER COLUMN CREATED_BY CHAR(6) NOT NULL
ALTER TABLE BINDER_REQUEST ALTER COLUMN CREATED_TS DATETIME NOT NULL
ALTER TABLE BINDER_REQUEST ALTER COLUMN UPDATED_BY CHAR(6) NOT NULL
ALTER TABLE BINDER_REQUEST ALTER COLUMN UPDATED_TS DATETIME NOT NULL
GO

CREATE TABLE BINDER_REQUEST_SOURCE_REF(
	BINDER_REQUEST_SOURCE_ID UNIQUEIDENTIFIER NOT NULL,
	CODE VARCHAR(50) NOT NULL,
	DESCRIPTION VARCHAR(50) NOT NULL
)
ALTER TABLE BINDER_REQUEST_SOURCE_REF ADD CONSTRAINT BINDER_REQUEST_SOURCE_REF_PK PRIMARY KEY NONCLUSTERED(BINDER_REQUEST_SOURCE_ID)
ALTER TABLE BINDER_REQUEST_SOURCE_REF ADD CONSTRAINT BINDER_REQUEST_SOURCE_REF_UQ_CODE UNIQUE(CODE)
GO
INSERT INTO BINDER_REQUEST_SOURCE_REF(BINDER_REQUEST_SOURCE_ID, CODE, DESCRIPTION) VALUES
	(NEWID(), 'LENDER', 'Lender'),
	(NEWID(), 'RECORD_CENTER', 'Record Center'),
	(NEWID(), 'HOC', 'HOC')
GO

ALTER TABLE BINDER_REQUEST ADD BINDER_REQUEST_SOURCE_ID UNIQUEIDENTIFIER NULL
ALTER TABLE BINDER_REQUEST ADD CONSTRAINT BINDER_REQUEST_FK_BINDER_REQUEST_SOURCE_ID FOREIGN KEY(BINDER_REQUEST_SOURCE_ID) REFERENCES BINDER_REQUEST_SOURCE_REF(BINDER_REQUEST_SOURCE_ID)
GO
UPDATE BINDER_REQUEST SET BINDER_REQUEST_SOURCE_ID = (SELECT BINDER_REQUEST_SOURCE_ID FROM BINDER_REQUEST_SOURCE_REF WHERE CODE = 'LENDER')
GO
ALTER TABLE BINDER_REQUEST ALTER COLUMN BINDER_REQUEST_SOURCE_ID UNIQUEIDENTIFIER NOT NULL
GO
DELETE FROM REVIEW_LEVEL_STATUS_REF WHERE CODE IN ('PENDING_VETTING_REVIEW', 'POST_VETTING_REVIEW')
			]]>
        </sql>
    </changeSet>
</databaseChangeLog>
